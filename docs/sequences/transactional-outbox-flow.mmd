sequenceDiagram
  autonumber
  participant C as Client
  participant A as API (/api/chat/messages)
  participant D as SQLite DB
  participant O as Outbox Publisher Worker
  participant R as Redis Stream
  participant RT as Agent Runtime

  C->>A: POST /api/chat/messages (content, threadId?)
  A->>D: BEGIN TRANSACTION
  A->>D: INSERT message (user)
  A->>D: INSERT run (queued)
  A->>D: INSERT outbox_event (pending, attempts=0)
  A->>D: COMMIT
  A-->>C: 202 Accepted (runId, threadId, messageId)

  loop Poll retryable outbox rows
    O->>D: SELECT outbox_events WHERE status in (pending, failed)
    alt Publish succeeds
      O->>R: XADD agent_events event=<agent.run.requested>
      O->>D: UPDATE outbox_event status=published, published_at=now
    else Publish fails
      O->>D: UPDATE outbox_event status=failed, attempts=attempts+1, last_error=...
    end
  end

  R-->>RT: Consumer group reads event
  RT->>D: UPDATE run status=processing
  RT->>D: INSERT message (assistant)
  RT->>R: XADD agent.run.completed (or failed)
  RT->>D: UPDATE run status=completed (or failed)
